<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transaction History - Quant Invest</title>

  <!-- iOS-optimized Font Stack (System fonts + Inter fallback) -->
  <link rel="preconnect" href="https://rsms.me/">
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
  <link rel="stylesheet" href="../css/main.css">

</head>
<body class="bg-gray-50 font-sans">

  <main id="history-content" class="min-h-screen p-4 md:p-6">
    <!-- Content will be rendered here -->
  </main>

  <!-- Detail drawer -->
  <div
    id="detail-drawer"
    class="fixed right-0 top-0 h-full w-full md:w-96 bg-white shadow-xl transform translate-x-full transition-transform duration-300 z-50"
    role="dialog"
    aria-hidden="true"
  >
    <!-- Drawer content will be populated by JavaScript -->
  </div>

  <script type="module">
    import { mockData, formatCurrency } from '../js/data.js';
    import { DataTable } from '../js/ui.js';
    import { openDetailDrawer, closeDetailDrawer } from '../js/interactions.js';
    import { t } from '../js/i18n.js';

    let filteredTransactions = [...mockData.transactions];

    function renderHistory() {
      const content = document.getElementById('history-content');

      // Title
      const titleHtml = `
        <h1 class="text-2xl font-bold text-primary mb-6">${t('history.title')}</h1>
      `;

      // Filters
      const filtersHtml = `
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200 mb-6">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label for="dateFrom" class="block text-sm font-medium text-gray-700 mb-2">
                ${t('history.dateFrom')}
              </label>
              <input
                type="date"
                id="dateFrom"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent"
              />
            </div>
            <div>
              <label for="dateTo" class="block text-sm font-medium text-gray-700 mb-2">
                ${t('history.dateTo')}
              </label>
              <input
                type="date"
                id="dateTo"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent"
              />
            </div>
            <div>
              <label for="typeFilter" class="block text-sm font-medium text-gray-700 mb-2">
                ${t('history.type')}
              </label>
              <select
                id="typeFilter"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent"
                onchange="filterTransactions()"
              >
                <option value="all">${t('history.allTypes')}</option>
                <option value="deposit">${t('history.deposits')}</option>
                <option value="withdrawal">${t('history.withdrawals')}</option>
                <option value="allocation">${t('history.allocations')}</option>
              </select>
            </div>
            <div class="flex items-end">
              <button
                onclick="exportCSV()"
                class="w-full px-4 py-2 bg-white text-primary font-semibold rounded-lg border-2 border-primary hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-accent transition-colors"
              >
                ${t('history.export')}
              </button>
            </div>
          </div>
        </div>
      `;

      // Transaction table
      const tableHtml = `
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
          <div id="transaction-table">
            ${renderTable()}
          </div>
        </div>
      `;

      content.innerHTML = `
        ${titleHtml}
        ${filtersHtml}
        ${tableHtml}
      `;
    }

    function renderTable() {
      if (filteredTransactions.length === 0) {
        return `
          <div class="text-center py-12">
            <p class="text-gray-500">${t('history.noTransactions')}</p>
          </div>
        `;
      }

      return DataTable({
        columns: [
          { key: 'dateFormatted', label: t('history.date'), width: '25%' },
          { key: 'type', label: t('history.type'), width: '20%' },
          { key: 'amountFormatted', label: t('history.amount'), width: '25%' },
          { key: 'statusBadge', label: t('history.status'), width: '20%' },
          { key: 'actions', label: '', width: '10%' }
        ],
        rows: filteredTransactions.map(txn => {
          const statusColors = {
            pending: 'bg-yellow-100 text-yellow-800',
            completed: 'bg-green-100 text-green-800',
            failed: 'bg-red-100 text-red-800'
          };

          return {
            dateFormatted: new Date(txn.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }),
            type: txn.type.charAt(0).toUpperCase() + txn.type.slice(1),
            amountFormatted: formatCurrency(txn.amount),
            statusBadge: `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded ${statusColors[txn.status]}">${txn.status}</span>`,
            actions: `<button onclick='window.openDetailDrawer(${JSON.stringify(txn).replace(/'/g, "\\'")})'  class="text-accent hover:underline text-sm">Details</button>`,
            _raw: txn
          };
        }),
        onRowClick: null
      });
    }

    // Filter transactions
    window.filterTransactions = function() {
      const typeFilter = document.getElementById('typeFilter').value;

      filteredTransactions = mockData.transactions.filter(txn => {
        if (typeFilter !== 'all' && txn.type !== typeFilter) return false;
        return true;
      });

      document.getElementById('transaction-table').innerHTML = renderTable();
    };

    // Export CSV
    window.exportCSV = function() {
      const csv = [
        ['Date', 'Type', 'Amount', 'Status', 'Reference'].join(','),
        ...filteredTransactions.map(txn => [
          new Date(txn.date).toISOString(),
          txn.type,
          txn.amount,
          txn.status,
          txn.reference || ''
        ].join(','))
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    };

    // Make drawer functions globally available
    window.openDetailDrawer = openDetailDrawer;
    window.closeDetailDrawer = closeDetailDrawer;

    // Listen for language changes
    window.addEventListener('languagechange', () => {
      location.reload();
    });

    // Render on load
    renderHistory();
  </script>
</body>
</html>
